name: CI/CD ðŸš€
on:
  release:
    types: [prereleased, released]
  pull_request:
    types: [ready_for_review, synchronize, reopened, labeled]
  push:
    branches:
      - main
    tags:
      - v*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ###############################
  ########### LINTERS ###########
  ###############################
  # linters:
  #   name: "Linters ðŸ§¹"
  #   uses: ./.github/workflows/linters.yaml
  ###############################
  ############ TESTS ############
  ###############################
  # tests:
  #   name: Tests ðŸ§ª
  #   uses: ./.github/workflows/tests.yaml
  #   secrets: inherit
  ###############################
  ############ BUILD ############
  ###############################
  # build:
  #   name: "Build ðŸ”§"
  #   needs: [linters, tests]
  #   uses: ./.github/workflows/build.yaml
  ###############################
  ########### DEPLOY ############
  ###############################

  deploy:
    name: "Deploy ðŸš€"
    # needs:  [tests, linters, build]
    uses: ./.github/workflows/deploy.yaml
    secrets: inherit
    if: |
      github.event_name == 'release' ||
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.action == 'ready_for_review') ||
      (github.event_name == 'pull_request' && github.event.action == 'synchronize') ||
      (github.event_name == 'pull_request' && github.event.action == 'reopened') ||
      (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'needs-preview-deploy')
    with:
      environmentName: "${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || (github.event_name == 'release' && github.event.action == 'released' && 'production' || 'staging') }}"
      stacks: '["test"]'
      image: "false" # ${{ needs.build.outputs.image }}
